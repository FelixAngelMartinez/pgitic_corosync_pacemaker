---
- name: Aprovisionar máquinas
  hosts: nodo1
  remote_user: vagrant
  become: yes
  tasks:
  - name: Instalar paquetes necesarios
    apt:
      update_cache: yes
      force_apt_get: yes
      name: "{{ item }}"
      state: latest
    loop:
      - nginx
      - libqb0
      - fence-agents
      - pacemaker
      - ntp
  
  ### Configure Firewall ###
  - name: Comando iptables
    command: "iptables -A INPUT  -i eth1 -p udp -m multiport --dports 5404,5405,5406 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT"
  
  - name: Comando iptables 2
    command: "iptables -A OUTPUT  -o eth1 -p udp -m multiport --sports 5404,5405,5406 -m conntrack --ctstate ESTABLISHED -j ACCEPT"

  ### Configure Corosync ###
  # Create Cluster Authorization Key
  - name: Instalar paquete haveged
    apt:
      force_apt_get: yes
      name: haveged
  
  - name: Generar la clave de autenticación corosync
    command: corosync-keygen

  - name: Desinstalar paquete haveged
    apt:
      force_apt_get: yes
      autoclean: yes
      name: haveged
      state: absent

  - name: Descargamos authkey del master en local
    fetch:
      src: /etc/corosync/authkey
      dest: templates/authkey
      flat: yes

...