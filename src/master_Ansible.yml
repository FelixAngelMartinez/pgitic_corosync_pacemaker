---
- name: Aprovisionar máquinas
  hosts: nodo1
  remote_user: vagrant
  become: yes
  tasks:
  - name: Instalar paquetes necesarios
    apt:
      update_cache: yes
      force_apt_get: yes
      name: "{{ item }}"
      state: latest
    loop:
      - nginx
      - libqb0
      - fence-agents
      - pacemaker
      - ntp
  
  ### Configure Firewall ###
  # Equivalente al comando: 
  # iptables -A INPUT  -i eth1 -p udp -m multiport --dports 5404,5405,5406 
  #          -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
  - name: INPUT iptable
    iptables:
      chain: INPUT
      in_interface: eth1
      protocol: udp
      destination_port: "{{ item }}"
      ctstate: NEW,ESTABLISHED
      jump: ACCEPT
    loop:
      - 5404
      - 5405
      - 5406

  # Equivalente al comando:
  # iptables -A OUTPUT  -o eth1 -p udp -m multiport --sports 5404,5405,5406 
  #          -m conntrack --ctstate ESTABLISHED -j ACCEPT
  - name: OUTPUT iptable
    iptables:
      chain: OUTPUT
      out_interface: eth1
      protocol: udp
      source_port: "{{ item }}"
      ctstate: ESTABLISHED
      jump: ACCEPT
    loop:
      - 5404
      - 5405
      - 5406

  ### Configure Corosync ###
  # Create Cluster Authorization Key
  - name: Instalar paquete haveged
    apt:
      force_apt_get: yes
      name: haveged
  
  - name: Generar la clave de autenticación corosync
    command: corosync-keygen

  - name: Desinstalar paquete haveged
    apt:
      force_apt_get: yes
      autoclean: yes
      name: haveged
      state: absent

  - name: Descargamos authkey del master en local
    fetch:
      src: /etc/corosync/authkey
      dest: templates/authkey
      flat: yes

...