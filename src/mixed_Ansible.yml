---
- name: Aprovisionar máquinas
  hosts: all
  remote_user: vagrant
  become: yes
  pre_tasks:
  - name: Generar claves
    openssh_keypair:
      path: /home/vagrant/.ssh/id_rsa
      owner: vagrant
      group: vagrant

  - name: Fetch keys
    fetch:
      src: /home/vagrant/.ssh/id_rsa.pub
      dest: "keys/{{ ansible_facts['eth1']['ipv4']['address'] }}-id_rsa.pub"
      flat: yes

  - name: Copiar claves SSH entre nodos
    authorized_key:
      user: vagrant
      path: /home/vagrant/.ssh/authorized_keys
      state: present
      key: "{{ lookup('file', item) }}"
    with_fileglob:
      - "keys/*.pub"
    
  tasks:
  ### Configure Corosync Cluster
  - name: Modificamos el fichero de configuración de corosync desde plantilla .j2
    template:
      src: templates/corosync.j2
      dest: /etc/corosync/corosync.conf
     
  - name: Creamos el fichero pcmk desde plantilla
    template:
      src: templates/pacemaker.conf
      dest: /etc/corosync/service.d/pcmk

  - name: Cambiar linea de configuración para iniciar corosync
    lineinfile:
      path: /etc/default/corosync
      regexp: '^START='
      line: 'START=yes'

  - name: Reiniciar el servicio corosync
    service:
      name: corosync
      state: restarted

  ### Start and Configure Pacemaker ###
  - name: Ejecutar pacemaker desde el inicio
    command: update-rc.d pacemaker defaults 20 01

  - name: Iniciar el servicio pacemaker
    service:
      name: pacemaker
      state: restarted

...
